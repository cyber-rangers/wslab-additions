# Malware Hunting

## About the lab

Hunt different malware running on many Windows versions using various tools.

## LabConfig

```PowerShell
$InitialPoShCommands = 'New-Item -path "$PsHome\Profile.ps1" -type file -force','"(Get-Host).UI.RawUI.ForegroundColor = "White"" | out-file "$PsHome\Profile.ps1"','"(Get-Host).UI.RawUI.BackgroundColor = "Black"" | out-file -append "$PsHome\Profile.ps1"','"Write-Host Execution Policy set to Unrestricted. Console UI Updated." | out-file -append "$PsHome\Profile.ps1"','Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force -Confirm:$false'

$LabConfig=@{ DomainAdminName='LabAdmin'; AdminPassword='P@ssw0rd'; DomainName='cyberdefense-rangers.local'; DomainNetbiosName='RANGERS'; Prefix = 'ThreatHunting-'; SwitchName = 'LabSwitch'; DCEdition='4'; Internet=$true ; AdditionalNetworksConfig=@(); VMs=@()}

$LabConfig.VMs += @{ VMName = 'Client7' ; Configuration = 'Simple' ; ParentVHD = 'Win7SP1_G1.vhdx'  ; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True ; Generation=1; Unattend="DjoinCred"; CustomPowerShellCommands=$InitialPoShCommands}
$LabConfig.VMs += @{ VMName = 'Client81' ; Configuration = 'Simple'; ParentVHD = 'Win8.1_G2.vhdx' ; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True ;Unattend="DjoinCred"; CustomPowerShellCommands=$InitialPoShCommands }
$LabConfig.VMs += @{ VMName = 'Client101709' ; Configuration = 'Simple' ; ParentVHD = 'Win10RS3_G2.vhdx'  ; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True ; DisableWCF=$True ; vTPM=$True; NestedVirt=$true; CustomPowerShellCommands=$InitialPoShCommands}
$LabConfig.VMs += @{ VMName = 'Client101809' ; Configuration = 'Simple' ; ParentVHD = 'Win10RS5_G2.vhdx'  ; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True ; DisableWCF=$True ; vTPM=$True; NestedVirt=$true; CustomPowerShellCommands=$InitialPoShCommands}
$LabConfig.VMs += @{ VMName = 'Server12R2' ; Configuration = 'Simple'; ParentVHD = 'Win2012R2_G2.vhdx' ; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True ;Unattend="DjoinCred"; CustomPowerShellCommands=$InitialPoShCommands }
$LabConfig.VMs += @{ VMName = 'Server8R2' ; Configuration = 'Simple'; ParentVHD = 'Win2008R2SP1_G1.vhdx' ; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True; Unattend="DjoinCred" ; Generation = 1; CustomPowerShellCommands=$InitialPoShCommands}
$LabConfig.VMs += @{ VMName = 'Server16' ; Configuration = 'Simple'; ParentVHD = 'Win2016_G2.vhdx'; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True; vTPM=$True ; NestedVirt=$true; CustomPowerShellCommands=$InitialPoShCommands }
$LabConfig.VMs += @{ VMName = 'Server19' ; Configuration = 'Simple'; ParentVHD = 'Win2019_G2.vhdx'; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True; vTPM=$True ; NestedVirt=$true; CustomPowerShellCommands=$InitialPoShCommands }
$LabConfig.VMs += @{ VMName = 'ForeignDC8R2' ; Configuration = 'Simple'; ParentVHD = 'Win2008R2SP1_G1.vhdx' ; MemoryStartupBytes= 1GB ; MGMTNICs=1; AddToolsVHD=$True; Unattend="NoDjoin" ; Generation = 1; CustomPowerShellCommands=$InitialPoShCommands; AdditionalLocalAdmin='LabAdmin'}
 
```

## Scenario

Run the following command directly on ForeignDC8R2

```PowerShell
set-executionpolicy unrestricted -force -confirm:$false
cmd /c netsh interface ip set address "Local Area Connection" static 172.16.0.1 255.255.255.0 10.0.0.1
cmd /c netsh interface ip add dns "Local Area Connection" 10.0.0.1
. D:\Scripts\Install-TAFirst2008R2DomainController.ps1
Install-TAFirst2008R2DomainController -Domain foreign.local -NetBiosDomainName foreign -ADSite 'Nebrasca' -Domainlevel 4 -ForestLevel 4 -DSSafeModePassword 'P@ssw0rd'

```